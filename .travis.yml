# Copyright (c) 2017-2020 Petr Vorel <pvorel@suse.cz>

dist: bionic
sudo: required
language: c
services:
    - docker

matrix:
    include:
        # other builds
        - os: linux
          env: DISTRO=opensuse/tumbleweed
          compiler: gcc
        - os: linux
          env: DISTRO=fedora:latest MAKE_INSTALL=1
          compiler: clang

script:
    - INSTALL="${DISTRO%%:*}"
    - INSTALL="${INSTALL%%/*}"
    - if [ "$MAKE_INSTALL" = 1 ]; then INSTALL_OPT="-i"; fi
    - if [ ! "$TREE" ]; then TREE="in"; fi
    - case $VARIANT in cross-compile*) BUILD="cross";; i386) BUILD="32";; *) BUILD="native";; esac

    # podman
    - . /etc/os-release
    - echo "deb [arch=$(dpkg --print-architecture)] https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/testing/xUbuntu_${VERSION_ID}/ /" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:testing.list
    - curl -fsSL https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/testing/xUbuntu_${VERSION_ID}/Release.key | sudo apt-key add -
    - sudo apt-get update
    - sudo apt-get -y install podman runc
    - sudo mkdir -p /etc/containers
    - printf "[registries.search]\nregistries = [\"docker.io\"]\n" | sudo tee /etc/containers/registries.conf
    - cat /etc/containers/registries.conf
    - ls -la /etc/containers/registries.conf
    - podman version
    - runc --version
    - go version
    # runc
    - sudo apt build-dep runc
    - git clone https://github.com/opencontainers/runc.git && cd runc && git checkout v1.0.0-rc92
    - make -j$(getconf _NPROCESSORS_ONLN) BUILDTAGS="selinux seccomp"
    - sudo cp runc /usr/bin/runc
    - runc --version

    # ltp
    - DIR="/usr/src/ltp"
    - printf "FROM $DISTRO\nRUN mkdir -p $DIR\nWORKDIR $DIR\nCOPY . $DIR\n" > Dockerfile
    - cat Dockerfile
    - sudo podman build -t ltp .
    - sudo podman run -t ltp /bin/sh -c "cd travis && ./$INSTALL.sh && if [ \"$VARIANT\" ]; then ARCH=\"$ARCH\" ./$INSTALL.$VARIANT.sh; fi && ../build.sh -o $TREE -t $BUILD -c $CC $INSTALL_OPT"
